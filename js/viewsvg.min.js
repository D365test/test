function hasEdits(t){!Data.Edit.HasEdits&&t?(Data.Edit.HasEdits=!0,document.getElementById("menu-save").classList.add("changes"),document.title+=" *"):Data.Edit.HasEdits&&!t&&(Data.Edit.HasEdits=!1,document.getElementById("menu-save").classList.remove("changes"),document.title.endsWith(" *")&&(document.title=document.title.slice(0,-2)))}function getSvgXml(){return(new XMLSerializer).serializeToString(Data.Svg.Node)}function injectHighlightStyles(){const t=Data.Svg.Node.getElementById(STYLE_ID);t&&Data.Svg.Node.removeChild(t);const e=Data.Colours[0],a="5px",o=Data.Colours[0],n="2.5em",i="bold",s="Arial",d=document.createElement("style");d.id=STYLE_ID,d.textContent=`.${HIGH_CLASS_1}{fill:${Settings.Highlight1};}\n.${HIGH_CLASS_2}{fill:${Settings.Highlight2};}\n.${HIGH_CLASS_3}{fill:${Settings.Highlight3};}\n.${DRAW_CLASS}{stroke:${e};stroke-width:${a};stroke-linecap:round;stroke-linejoin:round;fill-opacity:25%;}\n.${TEXT_CLASS}{fill:${o};font-family:${s};font-size:${n};font-weight:${i};}`,Data.Svg.Node.appendChild(d)}function clearAllHighlights(){const t=Data.Svg.Node.getElementsByClassName(HIGH_CLASS_1);for(const e of Array.from(t))e.classList.remove(HIGH_CLASS_1);const e=Data.Svg.Node.getElementsByClassName(HIGH_CLASS_2);for(const t of Array.from(e))t.classList.remove(HIGH_CLASS_2);const a=Data.Svg.Node.getElementsByClassName(HIGH_CLASS_3);for(const t of Array.from(a))t.classList.remove(HIGH_CLASS_3);0===t.length&&0===e.length&&0===a.length||hasEdits(!0)}function findHighlightTarget(t){let e=t;for(;"tspan"===e.nodeName;)e=e.parentNode;if("text"===e.nodeName&&(e=e.parentNode),"g"===e.nodeName||"a"===e.nodeName){let t=e.getElementsByTagName("rect");if(0===t.length&&(t=e.getElementsByTagName("path")),0===t.length)return;e=t.item(0)}return"rect"===e.nodeName||"path"===e.nodeName||"circle"===e.nodeName||"ellipse"===e.nodeName?e:void 0}function resizeSvg(){var t;switch(Settings.Zoom){case"Fit":t=Math.min(window.innerWidth/Data.Svg.NativeWidth,window.innerHeight/Data.Svg.NativeHeight);break;case"Fit Width":t=window.innerWidth/Data.Svg.NativeWidth;break;case"Fit Height":t=window.innerHeight/Data.Svg.NativeHeight;break;case"Fill":t=Math.max(window.innerWidth/Data.Svg.NativeWidth,window.innerHeight/Data.Svg.NativeHeight);break;case"Original":t=1;break;default:throw"Unexpected Zoom setting: "+Settings.Zoom}Data.Svg.StartWidth=Data.Svg.NativeWidth*t,Data.Svg.StartHeight=Data.Svg.NativeHeight*t,Data.Svg.Node.style.width=Data.Svg.StartWidth.toFixed(0)+"px",Data.Svg.Node.style.height=Data.Svg.StartHeight.toFixed(0)+"px",Data.Zoom.Level=100;const e=window.innerWidth/2-Data.Svg.StartWidth/2,a=window.innerHeight/2-Data.Svg.StartHeight/2;Data.Svg.Node.style.left=e.toFixed(0)+"px",Data.Svg.Node.style.top=a.toFixed(0)+"px",Data.Svg.RatioX=Data.Svg.StartWidth/Data.Svg.NativeWidth,Data.Svg.RatioY=Data.Svg.StartHeight/Data.Svg.NativeHeight}function resetSvgPosition(){const t=parseFloat(Data.Svg.Node.style.width),e=window.innerWidth/2-t/2;Data.Svg.Node.style.left=e.toFixed(0)+"px";const a=parseFloat(Data.Svg.Node.style.height),o=window.innerHeight/2-a/2;Data.Svg.Node.style.top=o.toFixed(0)+"px"}function applyHighlightOnClick(t){const e=findHighlightTarget(t.target);e&&(e.classList.contains(HIGH_CLASS_1)?e.classList.remove(HIGH_CLASS_1):e.classList.contains(HIGH_CLASS_2)?e.classList.remove(HIGH_CLASS_2):e.classList.contains(HIGH_CLASS_3)?e.classList.remove(HIGH_CLASS_3):t.ctrlKey?e.classList.add(HIGH_CLASS_3):t.shiftKey?e.classList.add(HIGH_CLASS_2):e.classList.add(HIGH_CLASS_1),hasEdits(!0))}function addTextOnClick(){modalPrompt("Add text to diagram","",function(){let t=getModalInputText();if(t&&(t=t.trim()),t){const a=(Data.Pointer.X-parseFloat(Data.Svg.Node.style.left))/Data.Svg.RatioX,o=(Data.Pointer.Y-parseFloat(Data.Svg.Node.style.top))/Data.Svg.RatioY;var e=document.createElementNS(SVG_NAMESPACE,"text");e.setAttribute("class",TEXT_CLASS),e.setAttribute("transform",`translate(${a.toFixed(1)} ${o.toFixed(1)})`),e.textContent=t,Data.Svg.Node.appendChild(e),hasEdits(!0)}})}function cycleColour(t){let e=Data.Colours.indexOf(t);return-1===e&&(e=0),e=(e+1)%Data.Colours.length,Data.Colours[e]}function cycleDrawColour(){Data.Edit.Node.style.stroke=cycleColour(Data.Edit.Node.style.stroke),hasEdits(!0)}function cycleTextColour(){Data.Edit.Node.style.fill=cycleColour(Data.Edit.Node.style.fill),hasEdits(!0)}function auxClickEvent(t){if(t.button===Mouse.Button.Right&&!Data.IgnoreClick){switch(Data.Edit.Mode){case EditModes.Draw:t.target.classList.contains(DRAW_CLASS)&&(t.target.remove(),hasEdits(!0));break;case EditModes.Highlight:clearAllHighlights();break;case EditModes.Text:t.target.classList.contains(TEXT_CLASS)&&(t.target.remove(),hasEdits(!0));break;default:resizeSvg()}t.preventDefault()}}function clickSvgEvent(t){if(Data.IgnoreClick)t.preventDefault();else switch(Data.Edit.Mode){case EditModes.Highlight:applyHighlightOnClick(t),t.preventDefault();break;case EditModes.Draw:Data.Edit.Node&&cycleDrawColour(),t.preventDefault();break;case EditModes.Text:Data.Edit.Node?cycleTextColour():addTextOnClick(),t.preventDefault()}}function isDescendantOf(t,e){const a=e.toUpperCase();for(let e=t;e&&e!=document;e=e.parentNode)if(e.tagName.toUpperCase()===a)return!0;return!1}function updateTransform(){const t=[];0===Data.Edit.Transform.Translate.X&&0===Data.Edit.Transform.Translate.Y||t.push(`translate(${Data.Edit.Transform.Translate.X.toFixed(1)} ${Data.Edit.Transform.Translate.Y.toFixed(1)})`),0!==Data.Edit.Transform.Rotate&&t.push(`rotate(${Data.Edit.Transform.Rotate.toFixed(1)})`),1!==Data.Edit.Transform.Scale&&t.push(`scale(${Data.Edit.Transform.Scale.toFixed(2)})`),Data.Edit.Node.setAttribute("transform",t.join(" "))}function parseTransform(t){Data.Edit.Transform.Translate.X=0,Data.Edit.Transform.Translate.Y=0,Data.Edit.Transform.Rotate=0,Data.Edit.Transform.Scale=1;const e=t.getAttribute("transform");if(!e)return;const a=e.split(/\(|\s|\)/);for(let t=0;t<a.length;t++)switch(a[t]){case"translate":Data.Edit.Transform.Translate.X=parseFloat(a[++t]),Data.Edit.Transform.Translate.Y=parseFloat(a[++t]);break;case"rotate":Data.Edit.Transform.Rotate=parseFloat(a[++t]);break;case"scale":Data.Edit.Transform.Scale=parseFloat(a[++t])}}function pointerDown(t,e,a,o,n){if(t===document.body||isDescendantOf(t,"svg"))switch(Data.Pointer.IgnoreMove=!1,Data.Pointer.Moved=!1,Data.Pointer.X=e,Data.Pointer.Y=a,Data.Scroll.StartLeft=parseFloat(Data.Svg.Node.style.left),Data.Scroll.StartTop=parseFloat(Data.Svg.Node.style.top),Data.Edit.Node=void 0,Data.Action.Type=void 0,Data.Edit.Mode){case EditModes.Draw:if(t.classList.contains(DRAW_CLASS)){Data.Edit.Node=t,parseTransform(t);const e=t.getBBox();Data.Edit.Centre.X=e.x+e.width/2,Data.Edit.Centre.Y=e.y+e.height/2,Data.Action.Type=Actions.Move,Data.Pointer.X-=Data.Edit.Transform.Translate.X*Data.Svg.RatioX,Data.Pointer.Y-=Data.Edit.Transform.Translate.Y*Data.Svg.RatioY}else Data.IgnoreClick=!0,Data.Action.Type=Actions.Add;break;case EditModes.Text:if(t.classList.contains(TEXT_CLASS)){Data.Edit.Node=t,parseTransform(t);const e=t.getBBox();Data.Edit.Centre.X=e.x+e.width/2,Data.Edit.Centre.Y=e.y+e.height/2,o?Data.Action.Type=Actions.Resize:n?Data.Action.Type=Actions.Rotate:(Data.Action.Type=Actions.Move,Data.Pointer.X-=Data.Edit.Transform.Translate.X*Data.Svg.RatioX,Data.Pointer.Y-=Data.Edit.Transform.Translate.Y*Data.Svg.RatioY)}}}function mouseDown(t){Data.IgnoreClick=!1,t.buttons===Mouse.Buttons.Left?(Data.Pointer.IgnoreMove=!0,pointerDown(t.target,t.clientX,t.clientY,t.ctrlKey,t.shiftKey)):t.buttons===Mouse.Buttons.Right&&(Data.Pointer.IgnoreMove=!1)}function drawModePaint(t,e,a,o){if(Math.abs(t-Data.Pointer.X)+Math.abs(e-Data.Pointer.Y)<4)return;Data.Action.Active||(document.body.classList.add("drawing"),Data.Action.Active=!0,Data.IgnoreClick=!0,hasEdits(!0));const n=parseFloat(Data.Svg.Node.style.left),i=parseFloat(Data.Svg.Node.style.top);if(!Data.Edit.Node){const t=(Data.Pointer.X-n)/Data.Svg.RatioX,e=(Data.Pointer.Y-i)/Data.Svg.RatioY;var s=document.createElementNS(SVG_NAMESPACE,"path");s.setAttribute("class",DRAW_CLASS),s.setAttribute("d",`M${t.toFixed(1)} ${e.toFixed(1)}`),Data.Svg.Node.appendChild(s),Data.Edit.Node=s}const d=(t-n)/Data.Svg.RatioX,l=(e-i)/Data.Svg.RatioY;if(a){const t=Data.Edit.Node.attributes.d.value.lastIndexOf("L");-1!==t&&(Data.Edit.Node.attributes.d.value=Data.Edit.Node.attributes.d.value.slice(0,t))}Data.Edit.Node.attributes.d.value.endsWith("Z")&&(Data.Edit.Node.attributes.d.value=Data.Edit.Node.attributes.d.value.slice(0,-1)),Data.Edit.Node.attributes.d.value+=`L${d.toFixed(1)} ${l.toFixed(1)}`,o&&(Data.Edit.Node.attributes.d.value+="Z"),Data.Pointer.X=t,Data.Pointer.Y=e}function scrollMove(t,e){Data.Action.Active||(document.body.classList.add("scrolling"),Data.Action.Type=Actions.Scroll,Data.Action.Active=!0,Data.IgnoreClick=!0);const a=(Data.Scroll.StartLeft-Data.Pointer.X+t).toFixed(0);Data.Svg.Node.style.left=a+"px";const o=(Data.Scroll.StartTop-Data.Pointer.Y+e).toFixed(0);Data.Svg.Node.style.top=o+"px"}function translateNode(t,e){Data.Action.Active||(document.body.classList.add("moving"),Data.Action.Type=Actions.Move,Data.Action.Active=!0,Data.IgnoreClick=!0,hasEdits(!0)),Data.Edit.Transform.Translate.X=(t-Data.Pointer.X)/Data.Svg.RatioX,Data.Edit.Transform.Translate.Y=(e-Data.Pointer.Y)/Data.Svg.RatioY,updateTransform()}function rotateNode(t,e){Data.Action.Active||(document.body.classList.add("rotating"),Data.Action.Type=Actions.Rotate,Data.Action.Active=!0,Data.IgnoreClick=!0,hasEdits(!0));const a=(t-parseFloat(Data.Svg.Node.style.left))/Data.Svg.RatioX-Data.Edit.Transform.Translate.X,o=(e-parseFloat(Data.Svg.Node.style.top))/Data.Svg.RatioY-Data.Edit.Transform.Translate.Y;Data.Edit.Transform.Rotate=180*Math.atan(o/a)/Math.PI,a<0&&(Data.Edit.Transform.Rotate+=180),updateTransform()}function resizeNode(t){Data.Action.Active||(document.body.classList.add("resizing"),Data.Action.Type=Actions.Resize,Data.Action.Active=!0,Data.IgnoreClick=!0,Data.Edit.Transform.StartScale=Data.Edit.Transform.Scale,hasEdits(!0));const e=Data.Pointer.Y,a=-window.innerHeight-Data.Pointer.Y,o=(15-Data.Edit.Transform.StartScale)/e,n=(.05-Data.Edit.Transform.StartScale)/a;let i=Data.Pointer.Y-t;i>e&&(i=e),i<a&&(i=a),Data.Edit.Transform.Scale=Data.Edit.Transform.StartScale,Math.abs(i)>3&&(Data.Edit.Transform.Scale+=i*(i>0?o:n)),updateTransform()}function pointerMove(t,e,a,o){switch(Data.Edit.Mode){case EditModes.Off:case EditModes.Highlight:scrollMove(t,e);break;case EditModes.Draw:switch(Data.Action.Type){case Actions.Add:drawModePaint(t,e,a,o);break;case Actions.Move:translateNode(t,e)}break;case EditModes.Text:switch(Data.Action.Type){case Actions.Move:translateNode(t,e);break;case Actions.Rotate:rotateNode(t,e);break;case Actions.Resize:resizeNode(e);break;default:scrollMove(t,e)}}}function deleteHighlights(t){const e=findHighlightTarget(t);e&&(e.classList.includes(HIGH_CLASS_1)?(e.classList.remove(HIGH_CLASS_1),hasEdits(!0)):e.classList.includes(HIGH_CLASS_2)?(e.classList.remove(HIGH_CLASS_2),hasEdits(!0)):e.classList.includes(HIGH_CLASS_3)&&(e.classList.remove(HIGH_CLASS_3),hasEdits(!0)))}function eraserMove(t){switch(Data.Action.Active||(document.body.classList.add("erasing"),Data.Action.Type=Actions.Erase,Data.Action.Active=!0,Data.IgnoreClick=!0),Data.Edit.Mode){case EditModes.Highlight:deleteHighlights(t);break;case EditModes.Draw:t.classList.contains(DRAW_CLASS)&&(t.remove(),hasEdits(!0));break;case EditModes.Text:t.classList.contains(TEXT_CLASS)&&(t.remove(),hasEdits(!0))}}function mouseMove(t){if(!Data.Pointer.Moved){if(Data.Pointer.X===t.clientX&&Data.Pointer.Y===t.clientY)return;Data.Pointer.Moved=!0}Data.Pointer.IgnoreMove||(t.buttons===Mouse.Buttons.Left?pointerMove(t.clientX,t.clientY,t.ctrlKey,t.shiftKey):t.buttons===Mouse.Buttons.Right&&Data.Edit.Mode!==EditModes.Off&&eraserMove(t.target))}function zoomTimer(){if(!Data.Zoom.Trigger)return;Data.Zoom.Trigger=!1;const t=parseFloat(Data.Svg.Node.style.width),e=parseFloat(Data.Svg.Node.style.height),a=Data.Svg.StartWidth*Data.Zoom.Level/100,o=Data.Svg.StartHeight*Data.Zoom.Level/100;Data.Svg.Node.style.width=a.toFixed(0)+"px",Data.Svg.Node.style.height=o.toFixed(0)+"px",Data.Svg.RatioX=a/Data.Svg.NativeWidth,Data.Svg.RatioY=o/Data.Svg.NativeHeight;const n=parseFloat(Data.Svg.Node.style.left),i=parseFloat(Data.Svg.Node.style.top),s=a/t,d=o/e,l=Data.Pointer.X-n,r=Data.Pointer.Y-i,c=l*s-l,g=r*d-r,m=i-g,u=n-c;Data.Svg.Node.style.top=m.toFixed(0)+"px",Data.Svg.Node.style.left=u.toFixed(0)+"px"}function applyZoomStep(t){Data.Zoom.Level<100?t/=4:100===Data.Zoom.Level&&t<0&&(t/=4),Data.Zoom.Level+=t,Data.Zoom.Level>1e3?Data.Zoom.Level=1e3:Data.Zoom.Level<10&&(Data.Zoom.Level=10),Data.Zoom.Trigger=!0}function wheelEvent(t){t.preventDefault(),Data.Action.Active||Math.abs(t.deltaY)<.1||(Data.Pointer.X=t.clientX,Data.Pointer.Y=t.clientY,applyZoomStep(t.deltaY>0?-ZOOM_STEP_SIZE:ZOOM_STEP_SIZE))}function zoomKey(t){Data.Pointer.X=window.innerWidth/2,Data.Pointer.Y=window.innerHeight/2,applyZoomStep(t)}function scrollStep(t,e){if(0!==t){const e=parseFloat(Data.Svg.Node.style.left),a=window.innerHeight*t,o=e-a;Data.Svg.Node.style.left=o.toFixed(0)+"px"}if(0!==e){const t=parseFloat(Data.Svg.Node.style.top),a=window.innerWidth*e,o=t-a;Data.Svg.Node.style.top=o.toFixed(0)+"px"}}function keyUpEvent(t){if(t.target===document.body&&!Data.Action.Active)switch(t.key){case"+":zoomKey(ZOOM_STEP_SIZE),t.preventDefault();break;case"-":zoomKey(-ZOOM_STEP_SIZE),t.preventDefault();break;case"=":resizeSvg(),t.preventDefault();break;case"ArrowUp":scrollStep(0,-SCROLL_STEP_SIZE),t.preventDefault();break;case"ArrowDown":scrollStep(0,SCROLL_STEP_SIZE),t.preventDefault();break;case"ArrowLeft":scrollStep(-SCROLL_STEP_SIZE,0),t.preventDefault();break;case"ArrowRight":scrollStep(SCROLL_STEP_SIZE,0),t.preventDefault();break;case"Enter":resetSvgPosition(),t.preventDefault()}}function windowResize(){resizeSvg(),setMenuPosition()}function pinchZoom(t,e,a,o){const n=Math.abs(t-a)+Math.abs(e-o),i=n-Data.PinchZoom.Distance;Math.abs(i)<.1||(Data.IgnoreClick=!0,Data.Pointer.X=t+(a-t)/2,Data.Pointer.Y=e+(o-e)/2,applyZoomStep(i),Data.PinchZoom.X1=t,Data.PinchZoom.Y1=e,Data.PinchZoom.X2=a,Data.PinchZoom.Y2=o,Data.PinchZoom.Distance=n)}function touchStart(t){0===Data.Pointer.TouchCount&&1===t.touches.length?(Data.IgnoreClick=!1,Data.Pointer.IgnoreMove=!0,pointerDown(t.touches[0].target,t.touches[0].clientX,t.touches[0].clientY,t.ctrlKey,t.shiftKey),Data.Pointer.TouchCount=1):Data.Pointer.TouchCount<2&&2===t.touches.length?(Data.IgnoreClick=!1,1===Data.Pointer.TouchCount&&pointerUp(t),Data.PinchZoom.X1=t.touches[0].clientX,Data.PinchZoom.Y1=t.touches[0].clientY,Data.PinchZoom.X2=t.touches[1].clientX,Data.PinchZoom.Y2=t.touches[1].clientY,Data.PinchZoom.Distance=Math.abs(Data.PinchZoom.X1-Data.PinchZoom.X2)+Math.abs(Data.PinchZoom.Y1-Data.PinchZoom.Y2),Data.Pointer.TouchCount=2):0!==Data.Pointer.TouchCount&&pointerUp(t)}function touchMove(t){1===t.touches.length&&1===Data.Pointer.TouchCount?pointerMove(t.touches[0].clientX,t.touches[0].clientY,t.ctrlKey,t.shiftKey):2===t.touches.length&&2===Data.Pointer.TouchCount&&pinchZoom(t.touches[0].clientX,t.touches[0].clientY,t.touches[1].clientX,t.touches[1].clientY)}function pointerUp(){Data.Action.Active&&(document.body.classList.remove("moving"),document.body.classList.remove("drawing"),document.body.classList.remove("erasing"),document.body.classList.remove("resizing"),document.body.classList.remove("rotating"),document.body.classList.remove("scrolling"),Data.Action.Active=!1),Data.Pointer.TouchCount=0}function registerSvgEvents(){Data.Svg.Node.addEventListener("click",clickSvgEvent),window.addEventListener("auxclick",auxClickEvent),window.addEventListener("mousedown",mouseDown),window.addEventListener("mouseup",pointerUp),window.addEventListener("mousemove",mouseMove),window.addEventListener("touchstart",touchStart),window.addEventListener("touchend",pointerUp),window.addEventListener("touchmove",touchMove),window.addEventListener("keyup",keyUpEvent),window.addEventListener("wheel",wheelEvent,{passive:!1}),window.addEventListener("resize",windowResize),setInterval(zoomTimer,100)}function flagClick(){if(Data.Flags.includes(Data.Filename)){const t=Data.Flags.indexOf(Data.Filename);t>-1&&Data.Flags.splice(t,1)}else Data.Flags.push(Data.Filename);localStorage.setItem(StoreName.Flags,JSON.stringify(Data.Flags)),updateMenuFlag()}function loadFlags(){const t=localStorage.getItem(StoreName.Flags);if(t){const e=JSON.parse(t);e&&(Data.Flags=e)}}function readFilterValuesfromSvg(){const t=Data.Svg.Node.style.filter;if(""===t)return!1;const e=t.indexOf("brightness"),a=t.indexOf("contrast"),o=t.indexOf("hue-rotate"),n=t.indexOf("saturate"),i=getStringBetween(t,e,"(",")"),s=getStringBetween(t,a,"(",")"),d=getStringBetween(t,o,"(","deg"),l=getStringBetween(t,n,"(",")");return i&&(Data.Controls.Brightness.value=10*i),s&&(Data.Controls.Contrast.value=10*s),d&&(Data.Controls.Hue.value=d),l&&(Data.Controls.Saturation.value=10*l),!0}function filterChange(){Data.Svg.Node.style.filter=getFiltersCss(Data.Controls.Brightness.value,Data.Controls.Contrast.value,Data.Controls.Hue.value,Data.Controls.Saturation.value)}function imageControlsResetClick(){Data.Controls.Brightness.value=Data.Controls.Brightness.defaultValue,Data.Controls.Contrast.value=Data.Controls.Contrast.defaultValue,Data.Controls.Hue.value=Data.Controls.Hue.defaultValue,Data.Controls.Saturation.value=Data.Controls.Saturation.defaultValue,filterChange()}function imageControlsSaveClick(){Settings.Filters.Brightness=Data.Controls.Brightness.value,Settings.Filters.Contrast=Data.Controls.Contrast.value,Settings.Filters.Hue=Data.Controls.Hue.value,Settings.Filters.Saturation=Data.Controls.Saturation.value,saveSettings(),Data.Controls.Open=!1,setControlsPosition()}function setControlsPosition(){const t=document.getElementById("menu"),e=document.getElementById("image-controls"),a=Data.Controls.Open?t.clientHeight:-e.clientHeight-2;e.style.top=a+"px"}function setupImageControls(){Data.Controls.Brightness=document.getElementById("brightness"),Data.Controls.Contrast=document.getElementById("contrast"),Data.Controls.Hue=document.getElementById("hue"),Data.Controls.Saturation=document.getElementById("saturation"),Data.Controls.Brightness.value=Settings.Filters.Brightness,Data.Controls.Contrast.value=Settings.Filters.Contrast,Data.Controls.Hue.value=Settings.Filters.Hue,Data.Controls.Saturation.value=Settings.Filters.Saturation,Data.Controls.Brightness.addEventListener("input",filterChange),Data.Controls.Contrast.addEventListener("input",filterChange),Data.Controls.Hue.addEventListener("input",filterChange),Data.Controls.Saturation.addEventListener("input",filterChange),document.getElementById("image-controls-reset").addEventListener("click",imageControlsResetClick),document.getElementById("image-controls-save").addEventListener("click",imageControlsSaveClick)}function updateMenuFlag(){const t=document.getElementById("menu-flag");t&&(Data.Flags.includes(Data.Filename)?(t.title="Remove flag",t.className="flagged"):(t.title="Flag this diagram",t.className="unflagged"))}function updateDownloadButtonState(){const t=document.getElementById("menu-download-pdf"),e=document.getElementById("menu-download-png");navigator.onLine?(t&&(t.disabled=!1),e&&(e.disabled=!1)):(t&&(t.disabled=!0),e&&(e.disabled=!0))}function updateMenu(){const t=document.getElementById("menu-export-svg"),e=document.getElementById("menu-export-png"),a=document.getElementById("menu-download-pdf"),o=document.getElementById("menu-download-png");switch(Data.Edit.Mode){case EditModes.Off:Data.Svg.Node.classList.remove("edit-mode"),Data.Svg.Node.classList.remove("draw-mode"),Data.Svg.Node.classList.remove("highlight-mode"),Data.Svg.Node.classList.remove("text-mode"),document.getElementById("menu-edit").style.display="inline-block",document.getElementById("menu-highlight").style.display="none",document.getElementById("menu-draw").style.display="none",document.getElementById("menu-text").style.display="none",Data.IsSavedDiagram||(t&&(t.style.display="none"),e&&(e.style.display="none")),a&&(a.style.display="inline-block"),o&&(o.style.display="inline-block"),updateDownloadButtonState();break;case EditModes.Draw:Data.Svg.Node.classList.add("draw-mode"),Data.Svg.Node.classList.remove("highlight-mode"),Data.Svg.Node.classList.remove("text-mode"),document.getElementById("menu-edit").style.display="none",document.getElementById("menu-highlight").style.display="none",document.getElementById("menu-draw").style.display="inline-block",document.getElementById("menu-text").style.display="none";break;case EditModes.Highlight:Data.Svg.Node.classList.remove("draw-mode"),Data.Svg.Node.classList.add("highlight-mode"),Data.Svg.Node.classList.remove("text-mode"),document.getElementById("menu-edit").style.display="none",document.getElementById("menu-highlight").style.display="inline-block",document.getElementById("menu-draw").style.display="none",document.getElementById("menu-text").style.display="none";break;case EditModes.Text:Data.Svg.Node.classList.remove("draw-mode"),Data.Svg.Node.classList.remove("highlight-mode"),Data.Svg.Node.classList.add("text-mode"),document.getElementById("menu-edit").style.display="none",document.getElementById("menu-highlight").style.display="none",document.getElementById("menu-draw").style.display="none",document.getElementById("menu-text").style.display="inline-block"}Data.Edit.Mode!==EditModes.Off&&(Data.Svg.Node.classList.add("edit-mode"),Data.IsSavedDiagram||(t&&(t.style.display="inline-block"),e&&(e.style.display="inline-block")),a&&(a.style.display="none"),o&&(o.style.display="none"))}function setMenuPosition(){const t=document.getElementById("menu"),e=document.getElementById("menu-grip");Data.Menu.Open?(e.title="Close menu",e.className="close",window.innerWidth<450?(t.style.left=0,t.style.borderRadius=0):(t.style.removeProperty("left"),t.style.removeProperty("border-radius")),t.style.right=0):(e.title="Open menu",e.className="open",window.innerWidth<450&&(t.style.removeProperty("left"),t.style.removeProperty("border-radius")),t.style.right=-Data.Menu.Offset+"px")}function gripClick(){Data.Menu.Open=!Data.Menu.Open,setMenuPosition(),!Data.Menu.Open&&Data.Controls.Open&&(Data.Controls.Open=!1,setControlsPosition())}function menuEditClick(){switch(Data.Edit.Mode){case EditModes.Off:Data.Edit.Mode=EditModes.Highlight;break;case EditModes.Highlight:Data.Edit.Mode=EditModes.Draw;break;case EditModes.Draw:Data.Edit.Mode=EditModes.Text;break;case EditModes.Text:Data.Edit.Mode=EditModes.Off;break;default:throw`Unexpected Edit Mode: ${Data.Edit.Mode}`}updateMenu()}function menuControlsClick(){Data.Controls.Open=!Data.Controls.Open,setControlsPosition()}function saveSvg(t,e){const a=getSvgXml(),o={Title:t,SvgXml:a},n=JSON.stringify(o);localStorage.setItem(e,n),hasEdits(!1)}function saveOK(t){let e=getModalInputText();if(e&&(e=e.trim()),e){const a=Date.now().toString();saveSvg(e,a),t?t():window.location.href=`/viewsvg.htm#*${a}`}}function overwriteYes(t){saveSvg(Data.SavedDiagramTitle,Data.Filename),t&&t()}function overwriteNo(t,e){modalPrompt("Save diagram as:",Data.SavedDiagramTitle,()=>saveOK(t),e)}function requestSave(t){if(Data.IsSavedDiagram)modalConfirm("Overwrite existing diagram?",()=>overwriteYes(t),()=>overwriteNo(t),()=>{});else{const e=decodeURIComponent(Data.Filename);modalPrompt("Save diagram as:",e,()=>saveOK(t))}}function menuSaveClick(){requestSave()}function exportSvgClick(){const t=Data.IsSavedDiagram?Data.SavedDiagramTitle:decodeURIComponent(Data.Filename),e=getSvgXml();exportSvg(t+".svg",e)}function exportPngClick(){const t=Data.IsSavedDiagram?Data.SavedDiagramTitle:decodeURIComponent(Data.Filename),e=getSvgXml(),a=window.getComputedStyle(document.body).backgroundColor;exportPng(t+".png",e,a)}function backClick(){Data.Edit.HasEdits?modalConfirm("Would you like to save your changes before leaving this page?",()=>requestSave(backOrHome),backOrHome,()=>{}):backOrHome()}function setupMenu(){document.getElementById("menu-grip").addEventListener("click",gripClick),document.getElementById("menu-back").addEventListener("click",backClick),document.getElementById("menu-print").addEventListener("click",()=>window.print()),document.getElementById("menu-edit").addEventListener("click",menuEditClick),document.getElementById("menu-highlight").addEventListener("click",menuEditClick),document.getElementById("menu-draw").addEventListener("click",menuEditClick),document.getElementById("menu-text").addEventListener("click",menuEditClick),document.getElementById("menu-controls").addEventListener("click",menuControlsClick),document.getElementById("menu-save").addEventListener("click",menuSaveClick),document.getElementById("menu-export-svg").addEventListener("click",exportSvgClick),document.getElementById("menu-export-png").addEventListener("click",exportPngClick);const t=document.getElementById("menu-flag");t&&t.addEventListener("click",flagClick);const e=document.getElementById("menu-download-pdf");e&&e.addEventListener("click",()=>document.getElementById("download-pdf").click());const a=document.getElementById("menu-download-png");a&&a.addEventListener("click",()=>document.getElementById("download-png").click()),Data.Menu.Open="Open"===Settings.Menu}function legacyRedirect(){let t=window.location.href.indexOf("#");if(-1===t&&(t=window.location.href.indexOf("=")),-1===t||t===window.location.href.length-1)return!1;if("*"===window.location.href[t+1])return!1;const e=window.location.origin+"/"+window.location.href.substring(t+1)+".htm";return location.replace(e),!0}function loadSavedDiagram(){if(!window.location.hash||window.location.hash.length<=2)return modalAlert("Missing saved diagram details",Data.IsComparing?void 0:backOrHome),!1;Data.IsComparing?Data.Filename=window.location.hash.slice(2,-8):Data.Filename=window.location.hash.substring(2);const t=localStorage.getItem(Data.Filename);if(!t)return modalAlert("Failed to locate saved diagram",Data.IsComparing?void 0:backOrHome),!1;const e=JSON.parse(t);if(!e||!e.SvgXml)return modalAlert("Failed to process saved diagram data",Data.IsComparing?void 0:backOrHome),!1;Data.SavedDiagramTitle=e.Title,document.title=`Saved Diagram: ${e.Title} | M365 Maps`;const a=e.SvgXml.replace(/<!--.*-->/i,"").replace(/<\?xml.*\?>/i,"").replace(/<!doctype.*>/i,"").replace(/^[\n\r]+/,"");return Data.Svg.Node=createElementFromHtml(a),document.body.appendChild(Data.Svg.Node),!0}function DOMContentLoaded(){setupModal(),Data.IsComparing?(document.body.style.overflow="hidden",document.getElementById("menu").style.display="none",document.getElementById("image-controls").style.display="none"):(setupMenu(),setupOfflineIndicator(),window.addEventListener("offline",updateDownloadButtonState),window.addEventListener("online",updateDownloadButtonState),Data.IsSavedDiagram||(loadFlags(),Data.Filename=window.location.pathname.slice(1,-4))),setupImageControls()}function pageLoad(){if(Data.IsSavedDiagram){const t=loadSavedDiagram();if(!t)return}else Data.Svg.Node=document.getElementsByTagName("svg").item(0);Data.Svg.NativeWidth=parseFloat(Data.Svg.Node.getAttribute("width")),Data.Svg.NativeHeight=parseFloat(Data.Svg.Node.getAttribute("height")),resizeSvg(),injectHighlightStyles();const t=readFilterValuesfromSvg();t||filterChange(),Data.IsComparing||(updateMenu(),updateMenuFlag(),setMenuPosition(),setControlsPosition()),registerSvgEvents(),Data.Svg.Node.style.display="inline"}const SVG_NAMESPACE="http://www.w3.org/2000/svg",STYLE_ID="m365MapsHighlights",DRAW_CLASS="m365maps-draw",TEXT_CLASS="m365maps-text",HIGH_CLASS_1="highlight1",HIGH_CLASS_2="highlight2",HIGH_CLASS_3="highlight3",SCROLL_STEP_SIZE=.05,ZOOM_STEP_SIZE=20,EditModes={Off:0,Highlight:1,Draw:2,Text:3},Actions={None:0,Add:1,Move:2,Erase:3,Resize:4,Rotate:5,Scroll:6},Data={Action:{Active:!1,Type:Actions.None},Colours:["red","orange","yellow","green","blue","purple","black"],Controls:{Brightness:void 0,Contrast:void 0,Hue:void 0,Open:!1,Saturation:void 0},Edit:{HasEdits:!1,Mode:EditModes.Off,Node:void 0,Centre:{X:0,Y:0},Transform:{Rotate:0,Scale:1,Translate:{X:0,Y:0},StartScale:1}},Filename:"",Flags:[],IgnoreClick:!1,IsComparing:!1,IsSavedDiagram:!1,Menu:{Offset:284,Open:!1},PinchZoom:{Distance:0,X1:0,Y1:0,X2:0,Y2:0},Pointer:{IgnoreMove:!0,Moved:!1,TouchCount:0,X:0,Y:0},SavedDiagramTitle:"untitled",Scroll:{StartLeft:0,StartTop:0},Svg:{Node:void 0,StartWidth:0,StartHeight:0,NativeWidth:0,NativeHeight:0,RatioX:0,RatioY:0},Zoom:{Level:100,Trigger:!1}};Data.IsComparing=window.location.hash.endsWith("/compare"),Data.IsSavedDiagram="/viewsvg.htm"===window.location.pathname;let redirecting=!1;Data.IsSavedDiagram&&(redirecting=legacyRedirect()),redirecting||(document.addEventListener("DOMContentLoaded",DOMContentLoaded),window.addEventListener("load",pageLoad));